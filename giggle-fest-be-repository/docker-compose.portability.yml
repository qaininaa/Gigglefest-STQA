version: "3.8"

services:
  # PostgreSQL Database for testing
  postgres-test:
    image: postgres:15-alpine
    platform: linux/amd64
    environment:
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass
      POSTGRES_DB: gigglefest_test
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U testuser -d gigglefest_test"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - portability-test

  # Test on linux/amd64 (Intel/AMD x86_64)
  app-linux-amd64:
    build:
      context: .
      dockerfile: Dockerfile.test
      args:
        PLATFORM: linux/amd64
    platform: linux/amd64
    container_name: gigglefest-linux-amd64
    ports:
      - "8081:8080"
    environment:
      DATABASE_URL: postgresql://testuser:testpass@postgres-test:5432/gigglefest_test
      NODE_ENV: production
      PORT: 8080
      JWT_SECRET: test-secret-key-portability
      JWT_EXPIRES_IN: 1h
    depends_on:
      postgres-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s
    networks:
      - portability-test

  # Test on linux/arm64 (ARM 64-bit, Apple Silicon, AWS Graviton)
  app-linux-arm64:
    build:
      context: .
      dockerfile: Dockerfile.test
      args:
        PLATFORM: linux/arm64
    platform: linux/arm64
    container_name: gigglefest-linux-arm64
    ports:
      - "8082:8080"
    environment:
      DATABASE_URL: postgresql://testuser:testpass@postgres-test:5432/gigglefest_test
      NODE_ENV: production
      PORT: 8080
      JWT_SECRET: test-secret-key-portability
      JWT_EXPIRES_IN: 1h
    depends_on:
      postgres-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s
    networks:
      - portability-test

  # Test runner - runs portability tests against all platforms
  test-runner:
    image: node:20-alpine
    platform: linux/amd64
    container_name: portability-test-runner
    working_dir: /test
    volumes:
      - ./src/tests/portability:/test
    command: >
      sh -c "
        echo 'â³ Waiting for all platforms to be ready...' &&
        sleep 20 &&
        echo 'ğŸ§ª Running portability tests...' &&
        node tc_port_04_runner.js
      "
    depends_on:
      - app-linux-amd64
      - app-linux-arm64
    networks:
      - portability-test

networks:
  portability-test:
    driver: bridge
